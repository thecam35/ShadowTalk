
                        
             ito');
                    
                } catch (error) {
                    console.error("Error al eliminar grupo:", error);
                    alert("Error al eliminar el grupo: " + error.message);
                }
            }
        });

        leaveGroupBtn.addEventListener('click', async function() {
            const groupId = state.currentManagedGroup;
            const group = getGroupById(groupId);
            
            if (confirm(`¿Estás seguro de que quieres salir del grupo "${group.name}"?`)) {
                try {
                    // Actualizar en Firestore
                    await groupsRef.doc(groupId).update({
                        members: firebase.firestore.FieldValue.arrayRemove(currentUser.id)
                    });
                    
                    // Actualizar localmente
                    group.members = group.members.filter(id => id !== currentUser.id);
                    
                    // Si estábamos en ese grupo, salir
                    if (state.currentGroup === groupId) {
                        state.currentGroup = null;
                        renderChatMessages();
                    }
                    
                    // Cerrar el modal
                    groupManagementModal.style.display = 'none';
                    
                    // Mostrar feedback al usuario
                    alert(`Has salido del grupo ${group.name}`);
                    
                    // Actualizar la interfaz
                    renderGroups();
                    
                } catch (error) {
                    console.error("Error al salir del grupo:", error);
                    alert("Error al salir del grupo: " + error.message);
                }
            }
        });

        chatToggle.addEventListener('click', toggleChatFullscreen);

        showRegister.addEventListener('click', function() {
            loginPage.style.display = 'none';
            registerPage.style.display = 'flex';
        });

        showLogin.addEventListener('click', function() {
            registerPage.style.display = 'none';
            loginPage.style.display = 'flex';
        });

        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const userDoc = await usersRef.doc(userCredential.user.uid).get();
                
                if (!userDoc.exists) {
                    const emailName = email.split('@')[0];
                    await usersRef.doc(userCredential.user.uid).set({
                        name: emailName.toLowerCase().replace(/\s+/g, ''),
                        displayName: emailName,
                        email: email,
                        avatar: emailName.charAt(0).toUpperCase() + emailName.split(' ').slice(-1)[0].charAt(0).toUpperCase(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                        usernameChangeDate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    await usersRef.doc(userCredential.user.uid).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                currentUser = {
                    id: userCredential.user.uid,
                    email: userCredential.user.email,
                    ...(await usersRef.doc(userCredential.user.uid).get()).data()
                };
                
                loginPage.style.display = 'none';
                registerPage.style.display = 'none';
                appContent.style.display = 'block';
                
                await loadInitialData();
                
            } catch (error) {
                console.error("Error al iniciar sesión:", error);
                
                let errorMessage = "Error al iniciar sesión. ";
                if (error.code === 'auth/user-not-found') {
                    errorMessage += "No existe una cuenta con este correo.";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage += "Contraseña incorrecta.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage += "Demasiados intentos fallidos. Por favor intenta más tarde.";
                } else {
                    errorMessage += "Verifica tus credenciales e intenta nuevamente.";
                }
                
                alert(errorMessage);
            }
        });

        registerForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            
            if (password !== confirmPassword) {
                alert("Las contraseñas no coinciden");
                return;
            }
            
            if (password.length < 6) {
                alert("La contraseña debe tener al menos 6 caracteres");
                return;
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                const newUser = {
                    name: name.toLowerCase().replace(/\s+/g, ''),
                    displayName: name,
                    email: email,
                    avatar: name.charAt(0).toUpperCase() + name.split(' ').slice(-1)[0].charAt(0).toUpperCase(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    usernameChangeDate: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await usersRef.doc(userCredential.user.uid).set(newUser);
                
                currentUser = {
                    id: userCredential.user.uid,
                    ...newUser
                };
                
                registerPage.style.display = 'none';
                loginPage.style.display = 'none';
                appContent.style.display = 'block';
                
                await loadInitialData();
                
            } catch (error) {
                console.error("Error al registrar usuario:", error);
                
                let errorMessage = "Error al registrar el usuario. ";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage += "Este correo ya está registrado.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage += "El correo electrónico no es válido.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage += "La contraseña es demasiado débil.";
                } else {
                    errorMessage += "Por favor intenta nuevamente.";
                }
                
                alert(errorMessage);
            }
        });

        // Escuchar cambios en tiempo real
        function setupRealtimeListeners() {
            // Escuchar nuevos mensajes globales
            messagesRef.orderBy('time').limit(100).onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const newMessage = { id: change.doc.id, ...change.doc.data() };
                        
                        // Verificar si el mensaje ya existe
                        if (!chatMessages.some(msg => msg.id === newMessage.id)) {
                            chatMessages.push(newMessage);
                            
                            if (!state.currentGroup && !state.currentDirectMessage) {
                                renderChatMessages();
                            }
                        }
                    }
                });
            });
            
            // Escuchar nuevos mensajes en grupos
            groups.forEach(group => {
                db.collection(`groups/${group.id}/messages`)
                    .orderBy('time')
                    .limit(100)
                    .onSnapshot(snapshot => {
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                const newMessage = { id: change.doc.id, ...change.doc.data() };
                                
                                if (!group.messages.some(msg => msg.id === newMessage.id)) {
                                    if (!group.messages) group.messages = [];
                                    group.messages.push(newMessage);
                                    group.lastMessage = newMessage;
                                    
                                    // Incrementar contador de no leídos si no es el grupo actual
                                    if (state.currentGroup !== group.id) {
                                        group.unread = (group.unread || 0) + 1;
                                    }
                                    
                                    if (state.currentGroup === group.id) {
                                        renderChatMessages();
                                    }
                                    
                                    renderGroups();
                                }
                            }
                        });
                    });
            });
            
            // Escuchar nuevos mensajes directos
            directMessages.forEach(dm => {
                directMessagesRef.doc(dm.id)
                    .collection('messages')
                    .orderBy('time')
                    .limit(100)
                    .onSnapshot(snapshot => {
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                const newMessage = { id: change.doc.id, ...change.doc.data() };
                                
                                if (!dm.messages.some(msg => msg.id === newMessage.id)) {
                                    if (!dm.messages) dm.messages = [];
                                    dm.messages.push(newMessage);
                                    
                                    // Marcar como leído si es la conversación actual
                                    if (state.currentDirectMessage === dm.id) {
                                        change.doc.ref.update({ read: true });
                                        newMessage.read = true;
                                    }
                                    
                                    if (state.currentDirectMessage === dm.id) {
                                        renderChatMessages();
                                    }
                                    
                                    renderGroups();
                                }
                            }
                        });
                    });
            });
            
            // Escuchar nuevas notificaciones
            notificationsRef
                .where('userId', '==', currentUser.id)
                .orderBy('timestamp', 'desc')
                .limit(20)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const newNotification = { id: change.doc.id, ...change.doc.data() };
                            
                            if (!notifications.some(n => n.id === newNotification.id)) {
                                notifications.unshift(newNotification);
                                
                                // Mostrar alerta para nuevas notificaciones
                                if (newNotification.type === 'direct_message') {
                                    const sender = getUserById(newNotification.senderId);
                                    alert(`Nuevo mensaje de ${sender.displayName || sender.name}: ${newNotification.message}`);
                                } else if (newNotification.type === 'group_message') {
                                    const group = getGroupById(newNotification.groupId);
                                    const sender = getUserById(newNotification.senderId);
                                    alert(`Nuevo mensaje en ${group.name} de ${sender.displayName || sender.name}`);
                                } else if (newNotification.type === 'group_invite') {
                                    const group = getGroupById(newNotification.groupId);
                                    const sender = getUserById(newNotification.senderId);
                                    alert(`${sender.displayName || sender.name} te ha invitado al grupo ${group.name}`);
                                }
                            }
                        }
                    });
                });
        }

        auth.onAuthStateChanged(async (user) => {
            try {
                if (user) {
                    console.log("Usuario autenticado detectado:", user.uid);
                    
                    const userDoc = await usersRef.doc(user.uid).get();
                    
                    if (!userDoc.exists) {
                        console.log("Documento de usuario no existe, creando...");
                        
                        const emailName = user.email ? user.email.split('@')[0] : 'user';
                        await usersRef.doc(user.uid).set({
                            name: emailName.toLowerCase().replace(/\s+/g, ''),
                            displayName: emailName,
                            email: user.email,
                            avatar: emailName.charAt(0).toUpperCase(),
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                            usernameChangeDate: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        console.log("Documento de usuario creado exitosamente");
                    } else {
                        console.log("Documento de usuario encontrado");
                        await usersRef.doc(user.uid).update({
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    currentUser = {
                        id: user.uid,
                        email: user.email,
                        ...(await usersRef.doc(user.uid).get()).data()
                    };
                    
                    await loadInitialData();
                    setupRealtimeListeners();
                    
                    loginPage.style.display = 'none';
                    registerPage.style.display = 'none';
                    appContent.style.display = 'block';
                    
                } else {
                    console.log("No hay usuario autenticado");
                    currentUser = null;
                    appContent.style.display = 'none';
                    loginPage.style.display = 'flex';
                }
            } catch (error) {
                console.error("Error en el cambio de estado de autenticación:", error);
                
                const errorMessage = error.message || "Error desconocido al configurar la sesión";
                
                const errorElement = document.createElement('div');
                errorElement.className = 'card';
                errorElement.style.backgroundColor = 'rgba(244, 67, 54, 0.1)';
                errorElement.style.borderLeft = '3px solid var(--danger)';
                errorElement.innerHTML = `
                    <h3 style="color: var(--danger);">Error de autenticación</h3>
                    <p>${errorMessage}</p>
                    <button class="btn btn-sm" onclick="window.location.reload()">Recargar página</button>
                `;
                
                document.body.insertBefore(errorElement, document.body.firstChild);
                
                try {
                    await auth.signOut();
                } catch (signOutError) {
                    console.error("Error al cerrar sesión:", signOutError);
                }
            }
        });

        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const joinGroup = urlParams.get('join_group');
            const inviteCode = urlParams.get('code');
            
            if (joinGroup && inviteCode) {
                alert(`Has sido invitado a unirte al grupo ${joinGroup} con código ${inviteCode}. Inicia sesión para continuar.`);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        init();
    </script>
</body>
</html>
